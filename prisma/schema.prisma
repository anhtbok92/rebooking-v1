generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

model Account {
    id                String  @id @default(uuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?
    access_token      String?
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(uuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id                  String                @id @default(uuid())
    name                String?
    email               String                @unique
    emailVerified       DateTime?
    password            String? // Optional for OAuth users
    role                String                @default("CLIENT") // SUPER_ADMIN, ADMIN, STAFF, DOCTOR, or CLIENT
    phone               String?
    image               String?
    resetToken          String?
    resetTokenExpiry    DateTime?
    createdAt           DateTime              @default(now())
    updatedAt           DateTime              @updatedAt
    accounts            Account[]
    sessions            Session[]
    bookings            Booking[]
    carts               Cart[]
    favorites           Favorite[]
    ratings             Rating[]
    referralCode        String?               @unique
    referredById        String?
    referredBy          User?                 @relation("Referrals", fields: [referredById], references: [id])
    referrals           User[]                @relation("Referrals")
    referralPoints      Int                   @default(0)
    ReferralCode        ReferralCode[]
    ReferralReward      ReferralReward[]
    PromotionSubscriber PromotionSubscriber[]
    PointsRedemption    PointsRedemption[]
    discountUsages      DiscountUsage[]
    news                News[]
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

model Service {
    id            String     @id @default(uuid())
    name          String
    price         Int
    imageUrl      String?
    stripePriceId String?
    createdAt     DateTime   @default(now())
    updatedAt     DateTime   @updatedAt
    bookings      Booking[]
    carts         Cart[]
    favorites     Favorite[]
    ratings       Rating[]
}

model Booking {
    id             String   @id @default(uuid())
    serviceId      String
    service        Service  @relation(fields: [serviceId], references: [id])
    userId         String?
    user           User?    @relation(fields: [userId], references: [id])
    date           DateTime
    time           String
    paymentMethod  String
    mobileProvider String?
    email          String?
    userName       String
    phone          String
    status         String   @default("PENDING")
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt
    photos         Photo[]
}

model Photo {
    id        String   @id @default(uuid())
    bookingId String
    booking   Booking  @relation(fields: [bookingId], references: [id])
    url       String
    createdAt DateTime @default(now())
}

model Cart {
    id        String   @id @default(uuid())
    userId    String?
    user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
    serviceId String
    service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
    date      DateTime
    time      String
    quantity  Int      @default(1)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    expiresAt DateTime @default(dbgenerated("now() + interval '24 hours'"))

    @@index([userId])
    @@index([serviceId])
}

model Favorite {
    id        String   @id @default(uuid())
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    serviceId String
    service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())

    @@unique([userId, serviceId])
    @@index([userId])
}

model CartEmail {
    id        String    @id @default(uuid())
    userId    String?
    email     String
    cartItems Json // Store cart items as JSON
    sent      Boolean   @default(false)
    sentAt    DateTime?
    createdAt DateTime  @default(now())
    expiresAt DateTime // When the cart email offer expires
}

model ReferralCode {
    id                String   @id @default(uuid())
    code              String   @unique
    userId            String
    user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    pointsPerReferral Int      @default(100)
    usageCount        Int      @default(0)
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    @@index([userId])
}

model ReferralReward {
    id         String   @id @default(uuid())
    referrerId String
    referredId String
    points     Int
    bookingId  String?
    createdAt  DateTime @default(now())
    User       User?    @relation(fields: [userId], references: [id])
    userId     String?

    @@index([referrerId])
    @@index([referredId])
}

model PromotionSubscriber {
    id         String   @id @default(uuid())
    email      String   @unique
    name       String?
    phone      String?
    userId     String?
    user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
    subscribed Boolean  @default(true)
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@index([userId])
}

model PointsRedemption {
    id             String   @id @default(uuid())
    userId         String
    user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    points         Int
    discountAmount Int
    bookingId      String?
    status         String   @default("PENDING") // PENDING, APPLIED, EXPIRED
    createdAt      DateTime @default(now())
    expiresAt      DateTime

    @@index([userId])
}

model DiscountCode {
    id        String          @id @default(uuid())
    code      String          @unique
    type      String // "PERCENT" or "FIXED"
    value     Int // 10 = 10% or $10
    minAmount Int? // Minimum cart total
    maxUses   Int? // Max redemptions
    usedCount Int             @default(0)
    expiresAt DateTime?
    active    Boolean         @default(true)
    createdAt DateTime        @default(now())
    updatedAt DateTime        @updatedAt
    usages    DiscountUsage[]

    @@index([code])
}

model DiscountUsage {
    id             String       @id @default(uuid())
    discountCodeId String
    discountCode   DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)
    userId         String?
    user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
    email          String?
    userName       String?
    phone          String?
    discountAmount Int
    cartTotal      Int
    finalTotal     Int
    bookingId      String?
    createdAt      DateTime     @default(now())

    @@index([discountCodeId])
    @@index([userId])
    @@index([email])
}

model Rating {
    id        String   @id @default(uuid())
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    serviceId String
    service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
    rating    Int      // 1-5 stars
    comment   String?
    status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, serviceId])
    @@index([serviceId])
    @@index([userId])
    @@index([status])
}

model TimeSlot {
    id        String   @id @default(uuid())
    time      String   @unique
    isActive  Boolean  @default(true)
    order     Int      @default(0)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model SystemSettings {
    id        String   @id @default(uuid())
    key       String   @unique
    value     String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model News {
    id          String   @id @default(uuid())
    title       String
    slug        String   @unique
    excerpt     String?
    content     String
    coverImage  String?
    category    String   @default("NEWS") // NEWS, PROMOTION, EVENT
    tags        String[] // Array of tags
    published   Boolean  @default(false)
    publishedAt DateTime?
    authorId    String
    author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
    viewCount   Int      @default(0)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@index([authorId])
    @@index([category])
    @@index([published])
    @@index([publishedAt])
}
